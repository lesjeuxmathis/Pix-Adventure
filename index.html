<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ Pix'Adventure üé®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .end-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(45deg, #1a1a2e, #16213e, #0f3460);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 1s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .end-content {
            text-align: center;
            color: white;
            max-width: 600px;
        }

        .end-title {
            font-size: 4em;
            color: #4a90e2;
            text-shadow: 0 0 20px rgba(74, 144, 226, 0.8);
            margin-bottom: 20px;
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 20px rgba(74, 144, 226, 0.8); }
            to { text-shadow: 0 0 30px rgba(74, 144, 226, 1), 0 0 40px rgba(74, 144, 226, 0.6); }
        }

        .end-stats {
            font-size: 1.5em;
            margin: 20px 0;
            line-height: 1.8;
        }

        .end-buttons {
            margin-top: 30px;
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .end-btn {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .restart-btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }

        .new-map-btn {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }

        .end-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .ui-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #skinColorPicker {
            width: 40px;
            height: 30px;
            border: 2px solid #4a90e2;
            border-radius: 5px;
            cursor: pointer;
            background: none;
        }

        .sandbox-btn {
            padding: 8px 12px;
            background: linear-gradient(45deg, #f39c12, #e67e22);
            border: none;
            border-radius: 5px;
            color: white;
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .sandbox-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(243, 156, 18, 0.4);
        }

        .sandbox-btn.active {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        body {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            font-family: 'Courier New', monospace;
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .game-container {
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #4a90e2;
            box-shadow: 0 0 30px rgba(74, 144, 226, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            color: #4a90e2;
            text-shadow: 0 0 10px rgba(74, 144, 226, 0.5);
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .file-input-container {
            margin-bottom: 20px;
            text-align: center;
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(45deg, #4a90e2, #357abd);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            font-weight: bold;
            color: white;
        }

        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.4);
        }

        canvas {
            border: 3px solid #4a90e2;
            border-radius: 8px;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            display: block;
            margin: 0 auto;
        }

        .ui-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding: 10px;
            background: rgba(74, 144, 226, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(74, 144, 226, 0.3);
        }

        .ui-item {
            font-size: 1.2em;
            font-weight: bold;
        }

        .score { color: #ffd700; }
        .lives { color: #ff6b6b; }
        .message { color: #4ecdc4; }

        .controls {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-size: 0.9em;
            color: #aaa;
        }

        .controls-title {
            color: #4a90e2;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .fullscreen-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #4a90e2, #357abd);
            border: none;
            border-radius: 8px;
            color: white;
            padding: 12px 16px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            z-index: 1000;
        }

        .fullscreen-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.4);
        }

        .game-container.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            border-radius: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .game-container.fullscreen canvas {
            max-width: 90vw;
            max-height: 70vh;
        }

        .debug-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            font-family: monospace;
            display: none;
        }

        .map-info {
            text-align: center;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #888;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .pulsing {
            animation: pulse 1s infinite;
        }

        .language-selector {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        .language-select {
            background: rgba(74, 144, 226, 0.2);
            border: 2px solid #4a90e2;
            border-radius: 5px;
            color: white;
            padding: 8px 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            cursor: pointer;
        }

        .language-select option {
            background: #1a1a2e;
            color: white;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <button id="fullscreenBtn" class="fullscreen-btn">üî≥ Plein √âcran</button>
        <div class="language-selector">
            <select id="languageSelect" class="language-select">
                <option value="fr">üá´üá∑ Fran√ßais</option>
                <option value="en">üá¨üáß English</option>
            </select>
        </div>
        <div class="header">
            <h1>üéÆ Pix'Adventure</h1>
            <div class="map-info" id="mapInfo">Chargez une image de map pour commencer</div>
        </div>
        <div class="file-input-container">
            <input type="file" id="mapFile" class="file-input" accept="image/*">
            <label for="mapFile" class="file-label">üìÅ Charger une Map</label>
        </div>

        <div id="endScreen" class="end-screen">
            <div class="end-content">
                <div class="end-title">üéâ VICTOIRE ! üéâ</div>
                <div class="end-stats" id="endStats"></div>
                <div class="end-buttons">
                    <button class="end-btn restart-btn" onclick="game.restartFromEndScreen()">
                        üîÑ Rejouer
                    </button>
                    <button class="end-btn new-map-btn" onclick="game.loadNewMap()">
                        üìÅ Nouvelle Map
                    </button>
                </div>
            </div>
        </div>

        <canvas id="gameCanvas" width="800" height="600"></canvas>

        <div class="ui-panel">
            <div class="ui-item score">üí∞ Score: <span id="score">0</span></div>
            <div class="ui-controls">
                <input type="color" id="skinColorPicker" value="#ff6b6b" title="Couleur du skin">
                <button id="sandboxBtn" class="sandbox-btn">üñåÔ∏è Bac √† sable</button>
                <button id="editorBtn" class="sandbox-btn">üé® √âditeur</button>
            </div>
            <div class="ui-item message" id="gameMessage"></div>
            <div class="ui-item lives">‚ù§Ô∏è Vies: <span id="lives">3</span></div>
        </div>

        <div class="controls">
            <div class="controls-title">üéØ CONTR√îLES</div>
            <div>‚Üê ‚Üí ou A D : D√©placement | ‚Üë ou W ou ESPACE : Saut</div>
            <div>F12 : Mode Debug | R : Red√©marrer niveau</div>
        </div>
    </div>

    <div class="debug-info" id="debugInfo"></div>

    <script>
        class PixelPlatformer {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.fileInput = document.getElementById('mapFile');
                
                this.ZOOM = 20;
                this.GRAVITY = 0.5;
                this.JUMP_FORCE = -8;
                this.MOVE_SPEED = 3;
                this.MAX_FALL_SPEED = 15;
                
                this.COLORS = {
                    BLACK: [0, 0, 0],
                    YELLOW: [255, 255, 0],
                    RED: [255, 0, 0],
                    GREEN: [0, 255, 0],
                    BLUE: [0, 0, 255],
                    CYAN: [0, 255, 255],
                    VIOLET: [255, 0, 255],
                    WHITE: [255, 255, 255],
                    ORANGE: [255, 165, 0],
                    GRAY: [128, 128, 128]
                };

                this.TRANSLATIONS = {
                    fr: {
                        leverActivated: "üî∂ Levier activ√© ! Blocs gris d√©sactiv√©s !",
                        leverDeactivated: "üî∂ Levier d√©sactiv√© ! Blocs gris r√©activ√©s !",
                        mapColors2: "Vert=Spawn, Bleu=Fin, Cyan=Checkpoint, Violet=Boost, Orange=Levier, Gris=D√©sactivable"
                    },
                    en: {
                        leverActivated: "üî∂ Lever activated! Gray blocks disabled!",
                        leverDeactivated: "üî∂ Lever deactivated! Gray blocks reactivated!",
                        mapColors2: "Green=Spawn, Blue=End, Cyan=Checkpoint, Purple=Boost, Orange=Lever, Gray=Deactivatable"
                    }
                };

                this.currentLanguage = 'fr';
                
                this.gameState = {
                    loaded: false,
                    paused: false,
                    gameOver: false,
                    levelComplete: false,
                    debugMode: false,
                    sandboxMode: false
                };
                
                this.map = {
                    data: null,
                    width: 0,
                    height: 0,
                    image: null
                };
                
                this.player = {
                    x: 100,
                    y: 100,
                    width: this.ZOOM * 0.8,
                    height: this.ZOOM * 0.8,
                    vx: 0,
                    vy: 0,
                    onGround: false,
                    jumpBoost: 0,
                    color: '#ff6b6b',
                    trail: []
                };
                
                this.game = {
                    score: 0,
                    lives: 3,
                    coins: [],
                    checkpoints: [],
                    lastCheckpoint: null,
                    camera: { x: 0, y: 0 },
                    levers: [],
                    grayBlocksDisabled: false
                };
                
                this.keys = {};
                this.keysPressed = {};
                this.particles = [];
                
                this.init();
            }
            
            init() {
                this.fileInput.addEventListener('change', (e) => this.loadMap(e));
                this.setupControls();
                this.setupFullscreen();
                this.setupSkinColorPicker();
                this.setupSandboxMode();
                this.setupEditor();
                this.setupLanguage();
                this.showMessage("Chargement de la map par d√©faut...");
                this.loadDefaultMap();
                this.gameLoop();
            }
            
            async loadDefaultMap() {
                try {
                    const response = await fetch('Exemple/map.png');
                    if (!response.ok) {
                        this.showMessage("Chargez une map pour commencer l'aventure !");
                        return;
                    }
                    
                    const blob = await response.blob();
                    const img = await this.loadImageFromBlob(blob);
                    await this.processMapImage(img);
                    this.initializeLevel();
                    this.gameState.loaded = true;
                    this.showMessage("Map par d√©faut charg√©e ! Bonne chance !");
                    
                    document.getElementById('mapInfo').textContent = 
                        `Map: ${this.map.width}x${this.map.height} pixels`;
                } catch (error) {
                    console.log('Map par d√©faut non trouv√©e, en attente de chargement manuel');
                    this.showMessage("Chargez une map pour commencer l'aventure !");
                }
            }
            
            loadImageFromBlob(blob) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => {
                        URL.revokeObjectURL(img.src);
                        resolve(img);
                    };
                    img.onerror = reject;
                    img.src = URL.createObjectURL(blob);
                });
            }
            
            setupFullscreen() {
                const fullscreenBtn = document.getElementById('fullscreenBtn');
                const gameContainer = document.querySelector('.game-container');
                
                fullscreenBtn.addEventListener('click', () => {
                    if (!gameContainer.classList.contains('fullscreen')) {
                        gameContainer.classList.add('fullscreen');
                        fullscreenBtn.textContent = 'üî≤ Quitter';
                        this.canvas.width = Math.min(window.innerWidth * 0.9, 1200);
                        this.canvas.height = Math.min(window.innerHeight * 0.7, 800);
                    } else {
                        gameContainer.classList.remove('fullscreen');
                        fullscreenBtn.textContent = 'üî≥ Plein √âcran';
                        this.canvas.width = 800;
                        this.canvas.height = 600;
                    }
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && gameContainer.classList.contains('fullscreen')) {
                        gameContainer.classList.remove('fullscreen');
                        fullscreenBtn.textContent = 'üî≥ Plein √âcran';
                        this.canvas.width = 800;
                        this.canvas.height = 600;
                    }
                });
            }

            setupSkinColorPicker() {
                const colorPicker = document.getElementById('skinColorPicker');
                colorPicker.addEventListener('change', (e) => {
                    this.player.color = e.target.value;
                });
            }

            setupSandboxMode() {
                const sandboxBtn = document.getElementById('sandboxBtn');
                sandboxBtn.addEventListener('click', () => {
                    this.gameState.sandboxMode = !this.gameState.sandboxMode;
                    
                    if (this.gameState.sandboxMode) {
                        sandboxBtn.textContent = 'üñåÔ∏è Mode Normal';
                        sandboxBtn.classList.add('active');
                        this.game.lives = 999;
                        this.showMessage('üñåÔ∏è Mode Bac √† Sable activ√© - Vies infinies !');
                    } else {
                        sandboxBtn.textContent = 'üñåÔ∏è Bac √† sable';
                        sandboxBtn.classList.remove('active');
                        this.game.lives = 4;
                        this.playerDeath();
                        this.showMessage('üéÆ Mode Normal activ√©');
                    }
                    
                    this.updateUI();
                });
            }

            setupEditor() {
                const editorBtn = document.getElementById('editorBtn');
                editorBtn.addEventListener('click', () => {
                    window.open('editor.html', '_blank');
                });
            }

            setupLanguage() {
                const languageSelect = document.getElementById('languageSelect');
                const browserLang = navigator.language.split('-')[0];
                if (browserLang === 'en' || browserLang === 'fr') {
                    this.currentLanguage = browserLang;
                    languageSelect.value = browserLang;
                }
                
                languageSelect.addEventListener('change', (e) => {
                    this.currentLanguage = e.target.value;
                });
            }

            t(key) {
                return this.TRANSLATIONS[this.currentLanguage][key] || key;
            }
            
            setupControls() {
                document.addEventListener('keydown', (e) => {
                    this.keys[e.key.toLowerCase()] = true;
                    this.keysPressed[e.key.toLowerCase()] = true;
                    
                    if (e.key === ' ' || e.key === 'ArrowUp' || e.key === 'ArrowDown' || 
                        e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                        e.preventDefault();
                    }

                    if (e.key === 'F12') {
                        e.preventDefault();
                        this.toggleDebug();
                    }

                    if (e.key.toLowerCase() === 'r' && this.gameState.loaded) {
                        this.restartLevel();
                    }
                });
                
                document.addEventListener('keyup', (e) => {
                    this.keys[e.key.toLowerCase()] = false;
                });
            }
            
            async loadMap(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                try {
                    const img = await this.loadImage(file);
                    await this.processMapImage(img);
                    this.initializeLevel();
                    this.gameState.loaded = true;
                    this.showMessage("Map charg√©e ! Bonne chance !");
                    
                    document.getElementById('mapInfo').textContent = 
                        `Map: ${this.map.width}x${this.map.height} pixels`;
                        
                } catch (error) {
                    console.error('Erreur lors du chargement:', error);
                    this.showMessage("Erreur lors du chargement de la map !");
                }
            }
            
            loadImage(file) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = reject;
                    img.src = URL.createObjectURL(file);
                });
            }
            
            async processMapImage(img) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                this.map.data = ctx.getImageData(0, 0, img.width, img.height);
                this.map.width = img.width;
                this.map.height = img.height;
                this.map.image = img;
                
                this.analyzeMap();
            }
            
            analyzeMap() {
                const colors = {};
                let spawnFound = false;
                
                for (let y = 0; y < this.map.height; y++) {
                    for (let x = 0; x < this.map.width; x++) {
                        const color = this.getPixelColor(x, y);
                        const key = `${color[0]},${color[1]},${color[2]}`;
                        colors[key] = (colors[key] || 0) + 1;
                        
                        if (this.colorMatches(color, this.COLORS.GREEN) && !spawnFound) {
                            this.player.x = x * this.ZOOM;
                            this.player.y = y * this.ZOOM;
                            spawnFound = true;
                        }
                    }
                }
                
                if (this.gameState.debugMode) {
                    console.log('=== ANALYSE DE LA MAP ===');
                    console.log(`Taille: ${this.map.width}x${this.map.height}`);
                    console.log('Couleurs d√©tect√©es:', colors);
                    console.log('Point de spawn:', spawnFound ? 'Trouv√©' : 'Non trouv√©');
                }
            }
            
            initializeLevel() {
                this.game.coins = [];
                this.game.checkpoints = [];
                this.game.levers = [];
                this.game.grayBlocksDisabled = false;
                this.game.score = 0;
                this.game.lives = 3;
                this.particles = [];
                this.gameState.gameOver = false;
                this.gameState.levelComplete = false;
                
                for (let y = 0; y < this.map.height; y++) {
                    for (let x = 0; x < this.map.width; x++) {
                        const color = this.getPixelColor(x, y);
                        
                        if (this.colorMatches(color, this.COLORS.GREEN)) {
                            this.game.lastCheckpoint = { x: x * this.ZOOM, y: y * this.ZOOM };
                        } else if (this.colorMatches(color, this.COLORS.YELLOW)) {
                            this.game.coins.push({
                                x: x * this.ZOOM + this.ZOOM/2,
                                y: y * this.ZOOM + this.ZOOM/2,
                                collected: false,
                                pulse: Math.random() * Math.PI * 2
                            });
                        } else if (this.colorMatches(color, this.COLORS.CYAN)) {
                            this.game.checkpoints.push({
                                x: x * this.ZOOM,
                                y: y * this.ZOOM,
                                activated: false
                            });
                        } else if (this.colorMatches(color, this.COLORS.ORANGE)) {
                            this.game.levers.push({
                                x: x * this.ZOOM,
                                y: y * this.ZOOM,
                                activated: false,
                                pulse: 0
                            });
                        }
                    }
                }
                
                this.updateUI();
            }
            
            getPixelColor(x, y) {
                if (!this.map.data || x < 0 || y < 0 || x >= this.map.width || y >= this.map.height) {
                    return [0, 0, 0];
                }
                
                const index = (y * this.map.width + x) * 4;
                return [
                    this.map.data.data[index],
                    this.map.data.data[index + 1],
                    this.map.data.data[index + 2]
                ];
            }
            
            colorMatches(color1, color2, tolerance = 30) {
                return Math.abs(color1[0] - color2[0]) <= tolerance &&
                       Math.abs(color1[1] - color2[1]) <= tolerance &&
                       Math.abs(color1[2] - color2[2]) <= tolerance;
            }
            
            update() {
                if (!this.gameState.loaded || this.gameState.paused || this.gameState.gameOver) {
                    return;
                }
                
                this.updatePlayer();
                this.updateCamera();
                this.updateParticles();
                this.checkCollectibles();
                this.checkSpecialTiles();
                this.updateLevers();
                
                this.keysPressed = {};
            }
            
            updatePlayer() {
                const wasOnGround = this.player.onGround;
                
                if (this.keys['arrowleft'] || this.keys['d']) {
                    this.player.vx = -this.MOVE_SPEED;
                } else if (this.keys['arrowright'] || this.keys['q']) {
                    this.player.vx = this.MOVE_SPEED;
                } else {
                    this.player.vx *= 0.8;
                }
                
                if ((this.keys[' '] || this.keys['arrowup'] || this.keys['z']) && this.player.onGround) {
                    this.player.vy = this.JUMP_FORCE - this.player.jumpBoost;
                    this.player.jumpBoost = 0;
                    this.player.onGround = false;
                    this.addParticles(this.player.x + this.player.width/2, this.player.y + this.player.height, 5, this.player.color);
                }
                
                this.player.vy += this.GRAVITY;
                this.player.vy = Math.min(this.player.vy, this.MAX_FALL_SPEED);
                
                const newX = this.player.x + this.player.vx;
                if (!this.checkCollision(newX, this.player.y, this.player.width, this.player.height)) {
                    this.player.x = newX;
                } else {
                    this.player.vx = 0;
                }
                
                const newY = this.player.y + this.player.vy;
                if (!this.checkCollision(this.player.x, newY, this.player.width, this.player.height)) {
                    this.player.y = newY;
                    this.player.onGround = false;
                } else {
                    if (this.player.vy > 0) {
                        this.player.onGround = true;
                        if (!wasOnGround) {
                            this.addParticles(this.player.x + this.player.width/2, this.player.y + this.player.height, 3, '#ffd700');
                        }
                    }
                    this.player.vy = 0;
                }
                
                this.player.trail.push({
                    x: this.player.x + this.player.width/2,
                    y: this.player.y + this.player.height/2,
                    time: Date.now()
                });
                
                this.player.trail = this.player.trail.filter(p => Date.now() - p.time < 200);
            }
            
            checkCollision(x, y, width, height) {
                const x1 = Math.floor(x / this.ZOOM);
                const y1 = Math.floor(y / this.ZOOM);
                const x2 = Math.floor((x + width - 1) / this.ZOOM);
                const y2 = Math.floor((y + height - 1) / this.ZOOM);
                
                for (let my = y1; my <= y2; my++) {
                    for (let mx = x1; mx <= x2; mx++) {
                        const color = this.getPixelColor(mx, my);
                        
                        if (this.colorMatches(color, this.COLORS.BLACK) || 
                            this.colorMatches(color, this.COLORS.VIOLET)) {
                            return true;
                        }
                        
                        if (this.colorMatches(color, this.COLORS.GRAY) && !this.game.grayBlocksDisabled) {
                            return true;
                        }
                    }
                }
                return false;
            }
            
            updateLevers() {
                this.game.levers.forEach(lever => {
                    lever.pulse += 0.05;
                });
            }
            
            checkSpecialTiles() {
                const centerX = Math.floor((this.player.x + this.player.width / 2) / this.ZOOM);
                const centerY = Math.floor((this.player.y + this.player.height / 2) / this.ZOOM);
                const bottomY = Math.floor((this.player.y + this.player.height) / this.ZOOM);
                
                const currentColor = this.getPixelColor(centerX, centerY);
                const groundColor = this.getPixelColor(centerX, bottomY);
                
                if (this.colorMatches(currentColor, this.COLORS.RED)) {
                    this.playerDeath();
                    return;
                }
                
                if (this.colorMatches(currentColor, this.COLORS.BLUE)) {
                    this.levelComplete();
                    return;
                }
                
                if (this.colorMatches(currentColor, this.COLORS.VIOLET) || 
                    this.colorMatches(groundColor, this.COLORS.VIOLET)) {
                    this.player.jumpBoost = 5;
                    this.addParticles(this.player.x + this.player.width/2, this.player.y + this.player.height, 3, '#ff00ff');
                    this.showMessage('‚ö° Boost de saut activ√© !', 1000);
                }
                
                if (this.colorMatches(currentColor, this.COLORS.ORANGE)) {
                    this.game.levers.forEach(lever => {
                        const dx = this.player.x + this.player.width/2 - lever.x - this.ZOOM/2;
                        const dy = this.player.y + this.player.height/2 - lever.y - this.ZOOM/2;
                        
                        if (Math.abs(dx) < this.ZOOM && Math.abs(dy) < this.ZOOM && !lever.activated) {
                            lever.activated = true;
                            this.game.grayBlocksDisabled = !this.game.grayBlocksDisabled;
                            
                            if (this.game.grayBlocksDisabled) {
                                this.showMessage(this.t('leverActivated'));
                            } else {
                                this.showMessage(this.t('leverDeactivated'));
                            }
                            
                            this.addParticles(lever.x + this.ZOOM/2, lever.y + this.ZOOM/2, 20, '#ff8800');
                        }
                    });
                }
            }
