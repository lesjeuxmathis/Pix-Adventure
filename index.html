<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pix'Adventure</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: linear-gradient(135deg, #1a1a2e, #16213e); font-family: 'Courier New', monospace; color: white; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .game-container { background: rgba(0,0,0,0.8); padding: 20px; border-radius: 15px; border: 2px solid #4a90e2; box-shadow: 0 0 30px rgba(74,144,226,0.3); }
        h1 { color: #4a90e2; text-shadow: 0 0 10px rgba(74,144,226,0.5); font-size: 2.5em; text-align: center; margin-bottom: 10px; }
        .header { text-align: center; margin-bottom: 20px; }
        .map-info { text-align: center; margin-bottom: 10px; font-size: 0.9em; color: #888; }
        .file-input-container { margin-bottom: 20px; text-align: center; }
        .file-input { display: none; }
        .file-label { display: inline-block; padding: 12px 24px; background: linear-gradient(45deg, #4a90e2, #357abd); border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: all 0.3s; }
        .file-label:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(74,144,226,0.4); }
        canvas { border: 3px solid #4a90e2; border-radius: 8px; image-rendering: pixelated; box-shadow: 0 0 20px rgba(0,0,0,0.5); display: block; margin: 0 auto; }
        .ui-panel { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding: 10px; background: rgba(74,144,226,0.1); border-radius: 8px; }
        .ui-item { font-size: 1.2em; font-weight: bold; }
        .score { color: #ffd700; }
        .lives { color: #ff6b6b; }
        .message { color: #4ecdc4; }
        .ui-controls { display: flex; gap: 10px; align-items: center; }
        #skinColorPicker { width: 40px; height: 30px; border: 2px solid #4a90e2; border-radius: 5px; cursor: pointer; }
        .sandbox-btn { padding: 8px 12px; background: linear-gradient(45deg, #f39c12, #e67e22); border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; font-size: 12px; transition: all 0.3s; }
        .sandbox-btn:hover { transform: translateY(-1px); }
        .sandbox-btn.active { background: linear-gradient(45deg, #27ae60, #2ecc71); }
        .controls { text-align: center; margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; font-size: 0.9em; color: #aaa; }
        .controls-title { color: #4a90e2; font-weight: bold; margin-bottom: 5px; }
        .end-screen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(45deg, #1a1a2e, #16213e, #0f3460); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; }
        .end-content { text-align: center; color: white; max-width: 600px; }
        .end-title { font-size: 4em; color: #4a90e2; text-shadow: 0 0 20px rgba(74,144,226,0.8); margin-bottom: 20px; }
        .end-stats { font-size: 1.5em; margin: 20px 0; line-height: 1.8; }
        .end-buttons { margin-top: 30px; display: flex; gap: 20px; justify-content: center; }
        .end-btn { padding: 15px 30px; font-size: 1.2em; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: all 0.3s; }
        .restart-btn { background: linear-gradient(45deg, #27ae60, #2ecc71); color: white; }
        .new-map-btn { background: linear-gradient(45deg, #f39c12, #e67e22); color: white; }
        .end-btn:hover { transform: translateY(-3px); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .pulsing { animation: pulse 1s infinite; }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>Pix'Adventure</h1>
            <div class="map-info" id="mapInfo">Orange=Levier | Gris=Bloc desactivable</div>
        </div>
        <div class="file-input-container">
            <input type="file" id="mapFile" class="file-input" accept="image/*">
            <label for="mapFile" class="file-label">Charger Map</label>
        </div>
        <div id="endScreen" class="end-screen">
            <div class="end-content">
                <div class="end-title">VICTOIRE</div>
                <div class="end-stats" id="endStats"></div>
                <div class="end-buttons">
                    <button class="end-btn restart-btn" onclick="game.restartFromEndScreen()">Rejouer</button>
                    <button class="end-btn new-map-btn" onclick="game.loadNewMap()">Nouvelle Map</button>
                </div>
            </div>
        </div>
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div class="ui-panel">
            <div class="ui-item score">Score: <span id="score">0</span></div>
            <div class="ui-controls">
                <input type="color" id="skinColorPicker" value="#ff6b6b">
                <button id="sandboxBtn" class="sandbox-btn">Sandbox</button>
            </div>
            <div class="ui-item message" id="gameMessage"></div>
            <div class="ui-item lives">Vies: <span id="lives">3</span></div>
        </div>
        <div class="controls">
            <div class="controls-title">CONTROLES</div>
            <div>Fleches/WASD: Deplacement/Saut | R: Restart</div>
        </div>
    </div>
    <script>
        class PixelPlatformer {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.ZOOM = 20; this.GRAVITY = 0.5; this.JUMP_FORCE = -8; this.MOVE_SPEED = 3; this.MAX_FALL_SPEED = 15;
                this.COLORS = { BLACK:[0,0,0], YELLOW:[255,255,0], RED:[255,0,0], GREEN:[0,255,0], BLUE:[0,0,255], CYAN:[0,255,255], VIOLET:[255,0,255], WHITE:[255,255,255], ORANGE:[255,165,0], GRAY:[128,128,128] };
                this.gameState = { loaded:false, gameOver:false, levelComplete:false, sandboxMode:false, leversActivated:false };
                this.map = { data:null, width:0, height:0 };
                this.player = { x:100, y:100, width:this.ZOOM*0.8, height:this.ZOOM*0.8, vx:0, vy:0, onGround:false, jumpBoost:0, color:'#ff6b6b', trail:[] };
                this.game = { score:0, lives:3, coins:[], checkpoints:[], levers:[], lastCheckpoint:null, camera:{x:0,y:0} };
                this.keys = {}; this.particles = []; this.init();
            }
            init() {
                document.getElementById('mapFile').addEventListener('change', e => this.loadMap(e));
                document.addEventListener('keydown', e => { this.keys[e.key.toLowerCase()]=true; if ([' ','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) e.preventDefault(); if (e.key.toLowerCase()==='r' && this.gameState.loaded) this.restartLevel(); });
                document.addEventListener('keyup', e => this.keys[e.key.toLowerCase()]=false);
                document.getElementById('skinColorPicker').addEventListener('change', e => this.player.color=e.target.value);
                document.getElementById('sandboxBtn').addEventListener('click', () => { this.gameState.sandboxMode=!this.gameState.sandboxMode; const btn=document.getElementById('sandboxBtn'); if (this.gameState.sandboxMode) { btn.classList.add('active'); this.game.lives=999; } else { btn.classList.remove('active'); this.game.lives=3; } this.updateUI(); });
                this.gameLoop();
            }
            async loadMap(event) {
                const file = event.target.files[0]; if (!file) return;
                try {
                    const img = await new Promise((res,rej) => { const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=URL.createObjectURL(file); });
                    const c=document.createElement('canvas'), ctx=c.getContext('2d'); c.width=img.width; c.height=img.height; ctx.drawImage(img,0,0);
                    this.map.data=ctx.getImageData(0,0,img.width,img.height); this.map.width=img.width; this.map.height=img.height;
                    for (let y=0; y<img.height; y++) { for (let x=0; x<img.width; x++) { if (this.colorMatches(this.getPixelColor(x,y), this.COLORS.GREEN)) { this.player.x=x*this.ZOOM; this.player.y=y*this.ZOOM; break; }}}
                    this.initializeLevel(); this.gameState.loaded=true; document.getElementById('mapInfo').textContent=`Map: ${this.map.width}x${this.map.height}`;
                } catch(e) { console.error(e); }
            }
            initializeLevel() {
                this.game.coins=[]; this.game.checkpoints=[]; this.game.levers=[]; this.game.score=0; this.game.lives=this.gameState.sandboxMode?999:3; this.particles=[]; this.gameState.gameOver=false; this.gameState.levelComplete=false; this.gameState.leversActivated=false;
                for (let y=0; y<this.map.height; y++) { for (let x=0; x<this.map.width; x++) {
                    const c=this.getPixelColor(x,y);
                    if (this.colorMatches(c,this.COLORS.GREEN)) this.game.lastCheckpoint={x:x*this.ZOOM,y:y*this.ZOOM};
                    else if (this.colorMatches(c,this.COLORS.YELLOW)) this.game.coins.push({x:x*this.ZOOM+this.ZOOM/2,y:y*this.ZOOM+this.ZOOM/2,collected:false,pulse:Math.random()*Math.PI*2});
                    else if (this.colorMatches(c,this.COLORS.CYAN)) this.game.checkpoints.push({x:x*this.ZOOM,y:y*this.ZOOM,activated:false});
                    else if (this.colorMatches(c,this.COLORS.ORANGE)) this.game.levers.push({x:x*this.ZOOM,y:y*this.ZOOM,activated:false,pulse:Math.random()*Math.PI*2});
                }}
                this.updateUI();
            }
            getPixelColor(x,y) { if (!this.map.data||x<0||y<0||x>=this.map.width||y>=this.map.height) return [0,0,0]; const i=(y*this.map.width+x)*4; return [this.map.data.data[i],this.map.data.data[i+1],this.map.data.data[i+2]]; }
            colorMatches(c1,c2,t=30) { return Math.abs(c1[0]-c2[0])<=t && Math.abs(c1[1]-c2[1])<=t && Math.abs(c1[2]-c2[2])<=t; }
            update() {
                if (!this.gameState.loaded||this.gameState.gameOver) return;
                this.updatePlayer(); this.updateCamera(); this.updateParticles(); this.checkCollectibles(); this.checkSpecialTiles();
            }
            updatePlayer() {
                if (this.keys['arrowleft']||this.keys['a']) this.player.vx=-this.MOVE_SPEED; else if (this.keys['arrowright']||this.keys['d']) this.player.vx=this.MOVE_SPEED; else this.player.vx*=0.8;
                if ((this.keys[' ']||this.keys['arrowup']||this.keys['w']) && this.player.onGround) { this.player.vy=this.JUMP_FORCE-this.player.jumpBoost; this.player.jumpBoost=0; this.player.onGround=false; this.addParticles(this.player.x+this.player.width/2,this.player.y+this.player.height,5,this.player.color); }
                this.player.vy+=this.GRAVITY; this.player.vy=Math.min(this.player.vy,this.MAX_FALL_SPEED);
                const newX=this.player.x+this.player.vx; if (!this.checkCollision(newX,this.player.y,this.player.width,this.player.height)) this.player.x=newX; else this.player.vx=0;
                const newY=this.player.y+this.player.vy; if (!this.checkCollision(this.player.x,newY,this.player.width,this.player.height)) { this.player.y=newY; this.player.onGround=false; } else { if (this.player.vy>0) this.player.onGround=true; this.player.vy=0; }
                this.player.trail.push({x:this.player.x+this.player.width/2,y:this.player.y+this.player.height/2,time:Date.now()}); this.player.trail=this.player.trail.filter(p=>Date.now()-p.time<200);
            }
            checkCollision(x,y,w,h) {
                const x1=Math.floor(x/this.ZOOM),y1=Math.floor(y/this.ZOOM),x2=Math.floor((x+w-1)/this.ZOOM),y2=Math.floor((y+h-1)/this.ZOOM);
                for (let my=y1; my<=y2; my++) { for (let mx=x1; mx<=x2; mx++) {
                    const c=this.getPixelColor(mx,my);
                    if (this.colorMatches(c,this.COLORS.BLACK)) return true;
                    if (this.colorMatches(c,this.COLORS.GRAY) && !this.gameState.leversActivated) return true;
                }}
                return false;
            }
            checkSpecialTiles() {
                const cx=Math.floor((this.player.x+this.player.width/2)/this.ZOOM),cy=Math.floor((this.player.y+this.player.height/2)/this.ZOOM);
                const cc=this.getPixelColor(cx,cy);
                if (this.colorMatches(cc,this.COLORS.RED)) { this.playerDeath(); return; }
                if (this.colorMatches(cc,this.COLORS.BLUE)) { this.levelComplete(); return; }
                if (this.colorMatches(cc,this.COLORS.VIOLET) && this.player.jumpBoost===0) { this.player.jumpBoost=5; this.addParticles(this.player.x+this.player.width/2,this.player.y+this.player.height,5,'#ff00ff'); }
            }
            checkCollectibles() {
                this.game.coins.forEach(coin => { if (!coin.collected) { const dx=this.player.x+this.player.width/2-coin.x,dy=this.player.y+this.player.height/2-coin.y; if (Math.sqrt(dx*dx+dy*dy)<this.ZOOM*0.6) { coin.collected=true; this.game.score+=100; this.addParticles(coin.x,coin.y,10,'#ffd700'); this.updateUI(); } coin.pulse+=0.1; }});
                this.game.checkpoints.forEach(cp => { if (!cp.activated) { const dx=this.player.x+this.player.width/2-cp.x-this.ZOOM/2,dy=this.player.y+this.player.height/2-cp.y-this.ZOOM/2; if (Math.abs(dx)<this.ZOOM && Math.abs(dy)<this.ZOOM) { cp.activated=true; this.game.lastCheckpoint={x:cp.x,y:cp.y}; this.addParticles(cp.x+this.ZOOM/2,cp.y+this.ZOOM/2,15,'#00ffff'); }}});
                this.game.levers.forEach(lv => { if (!lv.activated) { const dx=this.player.x+this.player.width/2-lv.x-this.ZOOM/2,dy=this.player.y+this.player.height/2-lv.y-this.ZOOM/2; if (Math.abs(dx)<this.ZOOM && Math.abs(dy)<this.ZOOM) { lv.activated=true; this.gameState.leversActivated=true; this.addParticles(lv.x+this.ZOOM/2,lv.y+this.ZOOM/2,20,'#ffa500'); this.showMessage('Levier active - Blocs gris desactives!'); }} else { lv.pulse+=0.1; }});
            }
            playerDeath() { if (!this.gameState.sandboxMode) this.game.lives--; this.addParticles(this.player.x+this.player.width/2,this.player.y+this.player.height/2,20,this.player.color); if (this.game.lives<=0) this.gameState.gameOver=true; else this.respawnPlayer(); }
            respawnPlayer() { if (this.game.lastCheckpoint) { this.player.x=this.game.lastCheckpoint.x; this.player.y=this.game.lastCheckpoint.y; } this.player.vx=0; this.player.vy=0; this.updateUI(); }
            levelComplete() { this.gameState.levelComplete=true; const cc=this.game.coins.filter(c=>c.collected).length,tc=this.game.coins.length; document.getElementById('endStats').innerHTML=`Score: ${this.game.score}<br>Pieces: ${cc}/${tc}<br>Vies: ${this.game.lives}`; document.getElementById('endScreen').style.display='flex'; }
            restartLevel() { this.game.coins.forEach(c=>c.collected=false); this.game.checkpoints.forEach(cp=>cp.activated=false); this.game.levers.forEach(lv=>lv.activated=false); this.game.score=0; this.game.lives=this.gameState.sandboxMode?999:3; this.gameState.leversActivated=false; this.respawnPlayer(); this.gameState.gameOver=false; this.gameState.levelComplete=false; }
            restartFromEndScreen() { document.getElementById('endScreen').style.display='none'; this.restartLevel(); }
            loadNewMap() { document.getElementById('endScreen').style.display='none'; document.getElementById('mapFile').click(); }
            updateCamera() { const tx=this.player.x-this.canvas.width/2,ty=this.player.y-this.canvas.height/2; this.game.camera.x+=(tx-this.game.camera.x)*0.1; this.game.camera.y+=(ty-this.game.camera.y)*0.1; this.game.camera.x=Math.max(0,Math.min(this.map.width*this.ZOOM-this.canvas.width,this.game.camera.x)); this.game.camera.y=Math.max(0,Math.min(this.map.height*this.ZOOM-this.canvas.height,this.game.camera.y)); }
            addParticles(x,y,count,color) { for (let i=0; i<count; i++) this.particles.push({x:x+(Math.random()-0.5)*10,y:y+(Math.random()-0.5)*10,vx:(Math.random()-0.5)*4,vy:(Math.random()-0.5)*4-2,color:color,life:1,decay:0.02+Math.random()*0.02}); }
            updateParticles() { this.particles=this.particles.filter(p => { p.x+=p.vx; p.y+=p.vy; p.vy+=0.1; p.life-=p.decay; return p.life>0; }); }
            render() {
                this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
                if (!this.gameState.loaded) { this.ctx.fillStyle='#4a90e2'; this.ctx.font='bold 32px Courier'; this.ctx.textAlign='center'; this.ctx.fillText('Chargez une map',this.canvas.width/2,this.canvas.height/2); return; }
                this.renderMap(); this.renderPlayer(); this.renderCollectibles(); this.renderParticles();
            }
            renderMap() {
                const sx=Math.floor(this.game.camera.x/this.ZOOM),sy=Math.floor(this.game.camera.y/this.ZOOM),ex=Math.min(this.map.width,sx+Math.ceil(this.canvas.width/this.ZOOM)+1),ey=Math.min(this.map.height,sy+Math.ceil(this.canvas.height/this.ZOOM)+1);
                for (let y=sy; y<ey; y++) { for (let x=sx; x<ex; x++) {
                    const c=this.getPixelColor(x,y),scx=x*this.ZOOM-this.game.camera.x,scy=y*this.ZOOM-this.game.camera.y;
                    if (this.colorMatches(c,this.COLORS.BLACK)) { this.ctx.fillStyle='#2c3e50'; this.ctx.fillRect(scx,scy,this.ZOOM,this.ZOOM); }
                    else if (this.colorMatches(c,this.COLORS.RED)) { this.ctx.fillStyle='#e74c3c'; this.ctx.fillRect(scx,scy,this.ZOOM,this.ZOOM); }
                    else if (this.colorMatches(c,this.COLORS.GREEN)) { this.ctx.fillStyle='#27ae60'; this.ctx.fillRect(scx,scy,this.ZOOM,this.ZOOM); }
                    else if (this.colorMatches(c,this.COLORS.BLUE)) { this.ctx.fillStyle='#3498db'; this.ctx.fillRect(scx,scy,this.ZOOM,this.ZOOM); }
                    else if (this.colorMatches(c,this.COLORS.VIOLET)) { this.ctx.fillStyle='#9b59b6'; this.ctx.fillRect(scx,scy,this.ZOOM,this.ZOOM); }
                    else if (this.colorMatches(c,this.COLORS.GRAY)) { this.ctx.fillStyle=this.gameState.leversActivated?'rgba(128,128,128,0.3)':'#7f8c8d'; this.ctx.fillRect(scx,scy,this.ZOOM,this.ZOOM); }
                }}
            }
            renderPlayer() {
                this.ctx.globalAlpha=0.3; this.player.trail.forEach((p,i) => { this.ctx.globalAlpha=i/this.player.trail.length*0.3; this.ctx.fillStyle=this.player.color; this.ctx.fillRect(p.x-this.game.camera.x-2,p.y-this.game.camera.y-2,4,4); });
                this.ctx.globalAlpha=1; const scx=this.player.x-this.game.camera.x,scy=this.player.y-this.game.camera.y;
                this.ctx.fillStyle=this.player.color; this.ctx.fillRect(scx,scy,this.player.width,this.player.height); this.ctx.strokeStyle='#fff'; this.ctx.lineWidth=1; this.ctx.strokeRect(scx,scy,this.player.width,this.player.height);
            }
            renderCollectibles() {
                this.game.coins.forEach(coin => { if (!coin.collected) { const scx=coin.x-this.game.camera.x,scy=coin.y-this.game.camera.y,pulse=Math.sin(coin.pulse)*0.2+1,size=this.ZOOM*0.6*pulse; this.ctx.fillStyle='#ffd700'; this.ctx.beginPath(); this.ctx.arc(scx,scy,size/2,0,Math.PI*2); this.ctx.fill(); }});
                this.game.checkpoints.forEach(cp => { const scx=cp.x-this.game.camera.x+this.ZOOM/2,scy=cp.y-this.game.camera.y+this.ZOOM/2; this.ctx.fillStyle=cp.activated?'#00ff88':'#00ffff'; this.ctx.fillRect(scx-this.ZOOM/2,scy-this.ZOOM/2,this.ZOOM,this.ZOOM); });
                this.game.levers.forEach(lv => { const scx=lv.x-this.game.camera.x+this.ZOOM/2,scy=lv.y-this.game.camera.y+this.ZOOM/2; if (lv.activated) { const pulse=Math.sin(lv.pulse)*0.2+1; this.ctx.fillStyle='#00ff00'; this.ctx.shadowBlur=15*pulse; this.ctx.shadowColor='#00ff00'; } else { this.ctx.fillStyle='#ffa500'; this.ctx.shadowBlur=10; this.ctx.shadowColor='#ffa500'; } this.ctx.fillRect(scx-this.ZOOM/2,scy-this.ZOOM/2,this.ZOOM,this.ZOOM); this.ctx.shadowBlur=0; });
            }
            renderParticles() { this.particles.forEach(p => { this.ctx.globalAlpha=p.life; this.ctx.fillStyle=p.color; this.ctx.fillRect(p.x-this.game.camera.x-1,p.y-this.game.camera.y-1,2,2); }); this.ctx.globalAlpha=1; }
            showMessage(txt,dur=2000) { const el=document.getElementById('gameMessage'); el.textContent=txt; el.classList.add('pulsing'); setTimeout(() => { el.classList.remove('pulsing'); if (el.textContent===txt) el.textContent=''; },dur); }
            updateUI() { document.getElementById('score').textContent=this.game.score; document.getElementById('lives').textContent=this.game.lives; }
            gameLoop() { this.update(); this.render(); requestAnimationFrame(()=>this.gameLoop()); }
        }
        window.addEventListener('load', () => { window.game = new PixelPlatformer(); });
    </script>
</body>
</html>
